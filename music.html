<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa">
    <link rel="stylesheet" href="styles/table.css">
    <link rel="stylesheet" href="styles/music.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Music Player</title>
</head>

<body>
    <div id="loader">
        <div></div>
    </div>
    <div class="inputdevfixed">
        <input type="text" id="search" placeholder="Search Songs"> <button type="button" onclick="Search()" id="button">Search</button>
    </div> <br><br>
    <br>
    <div class="tablepadding">
        <div id="tablediv">
            <table id="recommended" class="result"></table>
            <table id="result" class="result"></table>
        </div>
        <div id="playerdiv">
            <div id="player">
                <img id="thumb" src="">
                <div>
                    <h4 id="heading"></h4><audio id="audio" src="" controls autoplay></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        const table = document.getElementById("result");
        const input = document.getElementById("search");
        if (localStorage.recentsongs) {
            songlist = localStorage.recentsongs;
            object = JSON.parse(songlist);
            table.innerHTML = '<tr><th colspan="3" style="text-align:center;"><h2>Recent Songs</h2></th></tr><tr><th>Cover</th><th>Title</th><th>Download</th></tr>'
            object.slice().reverse().forEach(music => {
                table.innerHTML += '<tr><td><img src="' + music.thumb + '"></td><td>' + music.title + '</td><td><button onclick="Play(\'' + music.id + '\',\'' + music.thumb + '\',\'' + music.title + '\')">Play</button><a href="youtube.html?id=' + music.id + '">Download</a><a target="_blank" href="https://www.youtube.com/watch?v=' + music.id + '">Watch In Youtube</a></td></tr>'
            });
            document.getElementById("tablediv").style.display = "block";
        }
        input.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                Search()
            }
        });

        document.getElementById("audio").addEventListener("error", function(e) {
            if (e.currentTarget.error.code = 2 && document.getElementById("audio").getAttribute("src") != "") {
                alert("Error Playing Song\n\n\nNote: VEVO songs are not playable due to copyright issues.");
            }
        });

        function Search() {
            let data = input.value;
            document.getElementById("loader").style.display = "flex";
            const URL = "https://vid.puffyan.us/api/v1/search?type=video&q=" + encodeURIComponent(data);
            fetch(URL).then(data => {
                return data.json();
            }).then(posts => {
                document.getElementById("loader").style.display = "none";
                table.innerHTML = '<tr><th>Cover</th><th>Title</th><th>Download</th></tr>';
                posts.forEach(post => {
                    var title = post.title;
                    var thumbnail = post.videoThumbnails[4].url;
                    var id = post.videoId;

                    var tr = '<tr><td><img src="' + thumbnail + '"></td><td>' + title + '</td><td><button onclick="Play(\'' + id + '\',\'' + thumbnail + '\',\'' + title + '\')">Play</button><a href="youtube.html?id=' + id + '">Download</a><a target="_blank" href="https://www.youtube.com/watch?v=' + id + '">Watch In Youtube</a></td></tr>';
                    table.innerHTML += tr;
                });
                document.getElementById("recommended").innerHTML = "";
                document.getElementById("tablediv").style.display = "block";
            });
        }

        function Play(id, thumb, title) {
            document.getElementById("thumb").src = thumb;
            document.getElementById("heading").innerHTML = title;
            const URL = "https://vid.puffyan.us/api/v1/videos/" + id + "?fields=adaptiveFormats,recommendedVideos";
            fetch(URL).then(data => {
                return data.json();
            }).then(posts => {
                var audiourl = posts.adaptiveFormats[1].url;
                document.getElementById("audio").src = audiourl;
                document.getElementById("playerdiv").style.display = "flex";
                const recommend = document.getElementById("recommended");
                recommend.innerHTML = '<tr><th colspan="3" style="text-align:center;"><h2>Suggested Songs</h2></th></tr><tr><th>Cover</th><th>Title</th><th>Download</th></tr>'
                posts.recommendedVideos.forEach(post => {
                    var title = post.title;
                    var thumbnail = post.videoThumbnails[4].url;
                    var id = post.videoId;

                    var tr = '<tr><td><img src="' + thumbnail + '"></td><td>' + title + '</td><td><button onclick="Play(\'' + id + '\',\'' + thumbnail + '\',\'' + title + '\')">Play</button><a href="youtube.html?id=' + id + '">Download</a><a target="_blank" href="https://www.youtube.com/watch?v=' + id + '">Watch In Youtube</a></td></tr>';
                    recommend.innerHTML += tr;
                })
            });
            if (localStorage.recentsongs) {
                const lastsong = {
                    id: id,
                    title: title,
                    thumb: thumb
                };
                songlist = JSON.parse(localStorage.recentsongs);
                songlist.push(lastsong);
                localStorage.recentsongs = JSON.stringify(songlist);

            } else {
                const newsong = [{
                    id: id,
                    title: title,
                    thumb: thumb
                }];
                localStorage.recentsongs = JSON.stringify(newsong);
            }
        }
    </script>
</body>

</html>